#!/bin/bash

self=${0}
script_name=$(basename ${self})
script_dir=$(dirname ${self})

if [[ ! -f ${script_dir}/../etc/build.conf ]]; then
    echo "Build config ${script_dir}/../etc/build.conf not found"
    if [[ -f ${script_dir}/../etc/build.conf.template ]]; then
        echo "Use ${script_dir}/../etc/build.conf.template as a template for ${script_dir}/../etc/build.conf"
    fi
    exit 1
else
    source ${script_dir}/../etc/build.conf
fi

if [[ $# < 2 ]]; then
    echo "Usage: ${script_name} PROJECT VERSION [OS=${CONTAINER_OS?}]"
    echo "Example: ${script_name} kelly 1.2.3"
    exit 1
fi

project=${1}
version=${2}
container_os=${3-${CONTAINER_OS?}}

tmp_dir=$(mktemp -d -p $(pwd))
if [[ $? != 0 ]]; then
    echo "Failed to create temp directory"
    exit 1
fi

docker run -t -i                            \
    -e "GITHUB_USER=${GITHUB_USER}"         \
    -e "GITHUB_PASSWORD=${GITHUB_PASSWORD}" \
    -v ${tmp_dir}:/tmp/                     \
    ten0s/${container_os}_otp16.3-1_build-env build ${project} ${version}

ret=$?
if [[ ${ret} != 0 ]]; then
    echo "Build FAILED"
else
    echo "Build SUCCEEDED: $(ls ${tmp_dir}/*)"
fi

exit ${ret}
